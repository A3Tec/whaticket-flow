#!/bin/bash

#######################################
# Whaticket Deploy Orchestrator
# Script principal que orquestra a instala√ß√£o
#######################################

set -euo pipefail  # Exit on error, undefined vars, pipe failures
IFS=$'\n\t'        # Better word splitting

#######################################
# Cores e Reset do Terminal
#######################################
tput init 2>/dev/null || true

#######################################
# Determina PROJECT_ROOT
# Resolve symlinks corretamente
# Ref: https://stackoverflow.com/questions/59895/
#######################################
get_project_root() {
  local source="${BASH_SOURCE[0]}"
  local project_root
  
  while [[ -h "$source" ]]; do
    project_root="$(cd -P "$(dirname "$source")" >/dev/null 2>&1 && pwd)"
    source="$(readlink "$source")"
    [[ $source != /* ]] && source="$project_root/$source"
  done
  
  project_root="$(cd -P "$(dirname "$source")" >/dev/null 2>&1 && pwd)"
  echo "$project_root"
}

readonly PROJECT_ROOT="$(get_project_root)"
readonly CONFIG_FILE="${PROJECT_ROOT}/config"
readonly LOG_FILE="${PROJECT_ROOT}/install.log"

#######################################
# Logging Functions
#######################################
log() {
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

log_info() {
  log "INFO: $*"
  echo "‚ÑπÔ∏è  $*"
}

log_success() {
  log "SUCCESS: $*"
  echo "‚úÖ $*"
}

log_error() {
  log "ERROR: $*"
  echo "‚ùå ERROR: $*" >&2
}

log_step() {
  log "STEP: $*"
  echo ""
  echo "üöÄ $*"
  echo "----------------------------------------"
}

#######################################
# Error Handling
#######################################
error_exit() {
  log_error "$1"
  echo ""
  echo "‚ùå Instala√ß√£o falhou!"
  echo "üìã Verifique o log: $LOG_FILE"
  exit "${2:-1}"
}

cleanup_on_error() {
  local exit_code=$?
  if [[ $exit_code -ne 0 ]]; then
    log_error "Script interrompido com c√≥digo: $exit_code"
    echo ""
    echo "‚ö†Ô∏è  Instala√ß√£o n√£o conclu√≠da"
    echo "üìã Log dispon√≠vel em: $LOG_FILE"
  fi
}

trap cleanup_on_error EXIT
trap 'error_exit "Instala√ß√£o cancelada pelo usu√°rio" 130' INT TERM

#######################################
# Valida√ß√µes de Pr√©-requisitos
#######################################
validate_environment() {
  log_step "Validando ambiente"
  
  # Verifica se n√£o est√° rodando como root
  if [[ $EUID -eq 0 ]]; then
    error_exit "‚ùå N√ÉO execute este script como root! Use um usu√°rio normal com sudo."
  fi
  
  # Verifica sudo
  if ! sudo -n true 2>/dev/null; then
    log_info "Solicitando privil√©gios sudo..."
    sudo -v || error_exit "Falha ao obter privil√©gios sudo"
  fi
  
  # Verifica sistema operacional
  if [[ ! -f /etc/os-release ]]; then
    error_exit "Sistema operacional n√£o identificado"
  fi
  
  source /etc/os-release
  if [[ "$ID" != "ubuntu" && "$ID" != "debian" ]]; then
    error_exit "Sistema operacional n√£o suportado: $ID. Use Ubuntu ou Debian."
  fi
  
  log_success "Ambiente validado: $PRETTY_NAME"
}

#######################################
# Import de M√≥dulos
#######################################
import_modules() {
  log_step "Carregando m√≥dulos"
  
  local modules=(
    "variables/manifest.sh"
    "utils/manifest.sh"
    "lib/manifest.sh"
  )
  
  for module in "${modules[@]}"; do
    local module_path="${PROJECT_ROOT}/${module}"
    
    if [[ ! -f "$module_path" ]]; then
      error_exit "M√≥dulo n√£o encontrado: $module"
    fi
    
    # shellcheck source=/dev/null
    source "$module_path" || error_exit "Falha ao carregar: $module"
    log_info "‚úì Carregado: $module"
  done
  
  log_success "Todos os m√≥dulos carregados"
}

#######################################
# Configura√ß√£o de Credenciais
#######################################
setup_config_file() {
  log_step "Configurando credenciais"
  
  # Cria arquivo de config se n√£o existir
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_info "Criando arquivo de configura√ß√£o..."
    
    # Valida vari√°veis necess√°rias
    if [[ -z "${deploy_password:-}" ]]; then
      error_exit "Vari√°vel 'deploy_password' n√£o definida"
    fi
    
    if [[ -z "${db_pass:-}" ]]; then
      error_exit "Vari√°vel 'db_pass' n√£o definida"
    fi
    
    # Cria arquivo de config
    cat > "$CONFIG_FILE" <<EOF
# Configura√ß√µes de Deploy
# Gerado em: $(date)
deploy_password=${deploy_password}
mysql_root_password=${mysql_root_password:-}
db_pass=${db_pass}
EOF
    
    log_success "Arquivo de configura√ß√£o criado"
  else
    log_info "Arquivo de configura√ß√£o j√° existe"
  fi
  
  # Protege arquivo com permiss√µes restritas
  sudo chown root:root "$CONFIG_FILE" || log_error "Falha ao alterar owner do config"
  sudo chmod 600 "$CONFIG_FILE" || log_error "Falha ao alterar permiss√µes do config"
  
  # Carrega configura√ß√µes
  # shellcheck source=/dev/null
  source "$CONFIG_FILE" || error_exit "Falha ao carregar configura√ß√µes"
  
  log_success "Configura√ß√µes carregadas e protegidas"
}

#######################################
# Execu√ß√£o de Etapa com Tratamento de Erro
#######################################
run_step() {
  local step_name="$1"
  local step_description="${2:-$step_name}"
  
  log_step "$step_description"
  
  if ! "$step_name"; then
    error_exit "Falha na etapa: $step_description"
  fi
  
  log_success "Conclu√≠do: $step_description"
  sleep 1
}

#######################################
# Pipeline de Instala√ß√£o do Sistema
#######################################
install_system_dependencies() {
  log_step "INSTALANDO DEPEND√äNCIAS DO SISTEMA"
  
  run_step "system_update" "Atualizando sistema"
  run_step "system_set_timezone" "Configurando timezone"
  run_step "system_set_ufw" "Configurando firewall"
  run_step "system_node_install" "Instalando Node.js e PostgreSQL"
  run_step "system_pm2_install" "Instalando PM2"
  run_step "system_docker_install" "Instalando Docker"
  run_step "system_puppeteer_dependencies" "Instalando depend√™ncias Puppeteer"
  run_step "system_snapd_install" "Instalando Snapd"
  run_step "system_nginx_install" "Instalando Nginx"
  
  log_success "Depend√™ncias do sistema instaladas"
}

#######################################
# Configura√ß√£o de Usu√°rio
#######################################
setup_deploy_user() {
  log_step "CONFIGURANDO USU√ÅRIO DE DEPLOY"
  
  run_step "system_create_user" "Criando usu√°rio deployautomatizaai"
  run_step "system_execute_comand" "Configurando permiss√µes"
  run_step "system_unzip_whaticket" "Descompactando aplica√ß√£o"
  
  log_success "Usu√°rio configurado"
}

#######################################
# Instala√ß√£o do Backend
#######################################
install_backend() {
  log_step "INSTALANDO BACKEND"
  
  run_step "backend_chrome_install" "Instalando Chrome/Chromium"
  run_step "backend_set_env" "Configurando vari√°veis de ambiente"
  run_step "backend_redis_create" "Criando container Redis"
  run_step "backend_node_dependencies" "Instalando depend√™ncias Node.js"
  run_step "backend_db_migrate" "Executando migrations"
  run_step "backend_db_seed" "Executando seeds"
  run_step "backend_start_pm2" "Iniciando backend com PM2"
  run_step "backend_nginx_setup" "Configurando Nginx para backend"
  
  log_success "Backend instalado"
}

#######################################
# Instala√ß√£o do Frontend
#######################################
install_frontend() {
  log_step "INSTALANDO FRONTEND"
  
  run_step "frontend_set_env" "Configurando vari√°veis de ambiente"
  run_step "frontend_node_dependencies" "Instalando depend√™ncias Node.js"
  run_step "frontend_start_pm2" "Iniciando frontend com PM2"
  run_step "frontend_nginx_setup" "Configurando Nginx para frontend"
  
  log_success "Frontend instalado"
}

#######################################
# Finaliza√ß√£o
#######################################
finalize_installation() {
  log_step "FINALIZANDO INSTALA√á√ÉO"
  
  run_step "system_nginx_conf" "Aplicando configura√ß√µes Nginx"
  run_step "system_nginx_restart" "Reiniciando Nginx"
  
  # Certbot (comentado por padr√£o)
  # run_step "system_certbot_install" "Instalando Certbot"
  # run_step "system_certbot_setup" "Configurando SSL"
  
  log_success "Instala√ß√£o finalizada"
}

#######################################
# Resumo da Instala√ß√£o
#######################################
print_summary() {
  echo ""
  echo "========================================"
  echo "‚úÖ INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!"
  echo "========================================"
  echo ""
  echo "üìã Informa√ß√µes:"
  echo "  ‚Ä¢ Frontend URL: ${frontend_url:-N√£o configurado}"
  echo "  ‚Ä¢ Backend URL: ${backend_url:-N√£o configurado}"
  echo "  ‚Ä¢ Usu√°rio: deployautomatizaai"
  echo ""
  echo "üìù Pr√≥ximos passos:"
  echo "  1. Configure o DNS apontando para este servidor"
  echo "  2. Execute o setup SSL (descomente system_certbot_setup)"
  echo "  3. Acesse a aplica√ß√£o pelo navegador"
  echo ""
  echo "üìã Log completo: $LOG_FILE"
  echo "========================================"
  echo ""
}

#######################################
# Fun√ß√£o Principal
#######################################
main() {
  echo "========================================"
  echo "üöÄ Whaticket - Deploy Automatizado"
  echo "========================================"
  echo ""
  
  log "Iniciando instala√ß√£o"
  
  # Valida√ß√µes iniciais
  validate_environment
  
  # Carrega m√≥dulos
  import_modules
  
  # Configura credenciais
  setup_config_file
  
  # Obt√©m URLs
  if declare -F get_urls >/dev/null; then
    run_step "get_urls" "Configurando URLs"
  fi
  
  # Pipeline de instala√ß√£o
  install_system_dependencies
  setup_deploy_user
  install_backend
  install_frontend
  finalize_installation
  
  # Resumo final
  print_summary
  
  log "Instala√ß√£o conclu√≠da com sucesso"
}

#######################################
# Execu√ß√£o
#######################################
main "$@"
